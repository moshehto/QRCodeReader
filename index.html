<body>
  <h1>Scan QR Code</h1>
  <div id="reader" style="width: 300px;"></div>
  <div id="status"></div>
  <button id="rescanBtn" style="display:none; margin-top: 20px;">ðŸ”„ Scan Another Ticket</button>

  <script>
    const scanner = new Html5Qrcode("reader");
    const statusDiv = document.getElementById("status");
    const rescanBtn = document.getElementById("rescanBtn");

    function startScanner() {
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decodedText) => {
          console.log("âœ… Scanned Text:", decodedText);
          statusDiv.textContent = "Checking ticket...";

          // Stop scanner
          await scanner.stop();
          document.getElementById("reader").innerHTML = "";
          rescanBtn.style.display = "block";

          // Extract ticket ID
          const lines = decodedText.split('\n');
          const ticketIdLine = lines.find(line => line.includes("Ticket ID:"));
          const ticketId = ticketIdLine ? ticketIdLine.split(":")[1].trim() : "";

          if (!ticketId) {
            statusDiv.textContent = "âŒ Could not read ticket ID from QR code.";
            return;
          }

          fetch("https://t3gg0lxjkd.execute-api.eu-north-1.amazonaws.com/prod/Checkin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticket_id: ticketId })
          })
          .then(res => res.json())
          .then(data => {
            console.log("ðŸ“¦ Response:", data);
            statusDiv.textContent = data.message || "Unknown response";
          })
          .catch(err => {
            console.error("âŒ Fetch Error:", err);
            statusDiv.textContent = "âŒ Something went wrong while checking in.";
          });
        },
        (err) => console.warn("Scan error:", err)
      ).catch(err => {
        console.error("Camera init failed:", err);
      });
    }

    // Initial start
    startScanner();

    // Rescan button
    rescanBtn.addEventListener("click", () => {
      rescanBtn.style.display = "none";
      statusDiv.textContent = "";
      document.getElementById("reader").innerHTML = "<div></div>"; // force DOM to reload
      startScanner();
    });
  </script>
</body>
